package web

import (
	"encoding/json"

	"cve-sa-backend/dao"
	"cve-sa-backend/iniconf"
	"cve-sa-backend/models"
	_const "cve-sa-backend/utils/const"
	cveSa "cve-sa-backend/utils/entity/cve_sa"
)

func FindAllOsv(req cveSa.RequestOsv) (*cveSa.ResultOSVData, error) {
	datas, total, err := dao.OSVFindAll(req)
	if err != nil {
		iniconf.SLog.Error(err)
		return nil, err
	}

	OSVList := make([]models.ROeCompatibilityOsv, 0, len(datas))
	for _, v := range datas {
		var t []models.Record
		_ = json.Unmarshal([]byte(v.ToolsResult), &t)
		var p []models.Record
		_ = json.Unmarshal([]byte(v.PlatformResult), &p)

		OSVList = append(OSVList, models.ROeCompatibilityOsv{
			OeCompatibilityOsv: v,
			ToolsResult:        t,
			PlatformResult:     p,
			Updateime:          v.Updateime.Format(_const.Format),
		})
	}

	result := &cveSa.ResultOSVData{
		Total:   int(total),
		OsvList: OSVList,
	}

	return result, nil
}
